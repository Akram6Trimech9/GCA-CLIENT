<main role="main" class="col-md-9 ml-sm-auto col-lg-10 my-3">
    <div>
        <div class="head ">
            <span>Gestion des Honoraires</span>
            <div (click)="openModalFunction(myModalContent)" class="add-folder-icon">
                <i class="bi bi-plus"></i>
            </div>
        </div>
    </div>

    <!-- Grid Container -->
    <div class="form-group search-form ">
        <input type="text" id="clientSearch" class="form-control search-input" [(ngModel)]="searchTerm" (input)="filterClients()" placeholder="Chercher un client" />
        <ul *ngIf="filteredClients.length > 0" class="list-group mt-2">
            <li class="list-group-item" style="cursor: pointer;" *ngFor="let client of filteredClients" (click)="selectClient(client)">
                <i class="fas fa-user"></i> {{ client.username }} {{ client.lastname }}
            </li>
        </ul>
    </div>

    <div *ngIf="selectedClient" class="Info-section p-4 bg-white shadow-md rounded-lg mt-4">
        <img [src]="selectedClientInfo?.userProfile" alt="Image du Client" class="rounded-circle mr-4 user-profile" />
        <div>
            <div class="client-info flex items-center mb-4">
                <div>
                    <h4 class="text-lg font-semibold">{{ selectedClientInfo?.username }} {{ selectedClientInfo?.lastname }}</h4>
                    <p class="text-sm text-gray-600"><i class="fas fa-envelope"></i> {{ selectedClientInfo?.email }}</p>
                    <p class="text-sm text-gray-600"><i class="fas fa-phone"></i> {{ selectedClientInfo?.telephone1 }}</p>
                </div>
            </div>
            <div class="total-honoraires">
                <h4 class="font-semibold">Total Honoraires</h4>
                <p class="text-lg text-green-600 font-bold">{{ totalHonoraires | currency:'TND' }}</p>
            </div>
        </div>
    </div>

    <div id="grid-container" *ngIf="selectedClient" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
        <div *ngFor="let item of credits" class="card shadow-sm">
            <div class="card-body">
                <input type="radio" id="base" name="subscription" value="base">
                <h5 class="card-title">Affaire : {{ item.affaire.numeroAffaire }} - {{ item.affaire.natureAffaire }}</h5>
                <p class="card-text">Total Payé: <strong>{{ item.totalCredit | currency:'TND' }}</strong></p>
                <p class="card-text">Tranche payé: <i (click)="openPaymentModal(item)" class="fas fa-eye"></i></p>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-sm btn-primary" (click)="openHonorairesModal(item.client, item.affaire, item)">Modifier</button>
                    <button class="btn btn-sm btn-danger" (click)="deleteCredit(item._id)">Supprimer</button>
                </div>
            </div>
        </div>
    </div>
</main>

<ng-template #myModalContent let-modal>
    <div class="modal-header">
        <h5 class="modal-title" id="addAffaireModalLabel">Ajouter une nouvelle honoraire</h5>
        <button type="button" class="close" (click)="modal.dismiss()">
            <span>&times;</span>
        </button>
    </div>

    <div class="modal-body">
        <div class="form-group">
            <label for="clientSelect">Sélectionner le client</label>
            <select id="clientSelect" class="form-control" [(ngModel)]="selectedClient" (change)="onClientSelect($event)">
                <option selected> </option>
                <option *ngFor="let client of clients" [value]="client._id">{{ client.lastname }} {{ client.username }}</option>
            </select>
        </div>

        <div class="form-group" *ngIf="affaires && affaires.length > 0">
            <label for="affaireSelect">Sélectionner l'affaire</label>
            <select id="affaireSelect" class="form-control" [(ngModel)]="selectedAffaire" (change)="onAffaireSelect()">
                <option *ngFor="let affaire of affaires" [value]="affaire._id">{{ affaire.numeroAffaire }} {{ affaire.natureAffaire }}</option>
            </select>
        </div>

        <div *ngIf="selectedAffaire">
            <div class="form-group">
                <label for="totalCredit">Crédit Total</label>
                <input type="number" id="totalCredit" class="form-control" [(ngModel)]="credit.totalCredit" placeholder="Entrer le crédit total" />
            </div>

            <div *ngFor="let payment of credit.payedCredit; let i = index">
                <div class="form-group">
                    <label for="part{{ i }}">Montant Payé</label>
                    <input type="number" id="part{{ i }}" class="form-control" [(ngModel)]="payment.part" />
                </div>

                <div class="form-group">
                    <label for="date{{ i }}">Date</label>
                    <input type="date" id="date{{ i }}" class="form-control" [(ngModel)]="payment.date" />
                </div>

                <div class="form-group">
                    <label for="method{{ i }}">Méthode de Paiement</label>
                    <select id="method{{ i }}" class="form-control" [(ngModel)]="payment.method">
                        <option value="cheque">Chèque</option>
                        <option value="espece">Espèce</option>
                        <option value="credit card">Carte de Crédit</option>
                        <option value="bank transfer">Virement Bancaire</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="natureTranche">Nature de la Tranche</label>
                    <select id="natureTranche" class="form-control" [(ngModel)]="payment.natureTranche">
                        <option value="Avance">Avance</option>
                        <option value="Règlement définitif">Règlement définitif</option>
                        <option value="Frais">Frais</option>
                    </select>
                </div>

                <button type="button" class="btn btn-danger btn-sm" (click)="removePayment(i)">Supprimer</button>
            </div>

            <button type="button" class="btn btn-primary btn-sm mt-3" (click)="addPayment()">Ajouter un Paiement</button>
        </div>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">Fermer</button>
        <button type="button" class="btn btn-primary" (click)="saveCredit()">Enregistrer</button>
    </div>
</ng-template>

<ng-template #paymentModal let-modal>
    <div class="modal-header">
        <h5 class="modal-title">Détails des Paiements</h5>
        <button type="button" class="close" (click)="modal.dismiss()">
            <span>&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div *ngFor="let pay of selectedCredit?.payedCredit; let i = index" class="card mb-3">
            <div class="card-body">
                <button type="button" class="close float-right" (click)="removePaymentFromBd(i, pay._id)">
                    <span>&times;</span>
                </button>
                <h5 class="card-title">Détails du Paiement</h5>
                <p><strong>Part:</strong> {{ pay.part | currency:'TND' }}</p>
                <p><strong>Date:</strong> {{ pay.date | date }}</p>
                <p><strong>Méthode:</strong> {{ pay.method }}</p>
                <p><strong>Nature:</strong> {{ pay.natureTranche }}</p>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">Fermer</button>
    </div>
</ng-template>
